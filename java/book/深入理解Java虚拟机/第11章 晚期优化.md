[TOC]
### 11.1 概述

当虚拟机发现某个方法或者代码块运行特别频繁，就会把这些代码标为热点代码，为了提高热点代码的效率，在运行时，虚拟机把这些代码编译成与本地平台无关的机器码，并进行各种层次优化。，完成这个任务的编译期，就做即时编译器。

### 11.2 HotSpot虚拟机内的即时编译期。

#### 11.2.1 解释器和编译期

主要的商用虚拟机都同时包括解释器和编译器。
当程序需要迅速启动和执行的时候， 解释器就可以首先发挥作用，省去编译的时间，立即执行。当程序运行时，随着时间的推移，编译期逐渐发挥作用，把越来越多的代码编译成本地代码之后，可以获得更高的执行效率。
HotSpot内置了两个即时编译器，分别为C1编译期和C2编译期。
解释器和编译期搭配使用的方式成为混合模式。用户可以使用参数-Xint强制虚拟机运行在解释模式下，也可以使用参数-Xcomp强制虚拟机运行于编译模式。
分层编译的概念。

#### 11.2.2  编译对象与触发条件。

编译发生在方法执行之中，成为栈上替换。
如何判定热点代码；
1、基于采用的热点检测。
2、基于计数器的热点检测。
Hotspot采用第二种，它为每个方法准备了：方法调用计数器和回边计数器。
方法调用计数器：client模式1500次，server模式是10000次，可通过-XX：COmpileThreshold参数人工设定。
热度衰减和半衰周期。

回边计数器：
用于统计一个方法中循环体代码执行的次数。

#### 11.2.3 编译过程

在默认设置下，无论是方法调用产生的及时编译需求还是OSR编译需求，虚拟机在代码编译期还未完成之前，都是按照解释的方式继续执行，而编译动作则在后台的编译线程中执行。可以禁止后台编译。

#### 11.2.4 查看与分析及时编译结果。


### 11.3 编译优化技术。

* 编译期策略：

延迟编译、分层编译、栈上替换、延迟优化、程序依赖图表示、静态单赋值表示

*  基于性能监控的优化技术

乐观空值断言、乐观类型断言、乐观类型增强、乐观数组长度增强、裁剪未被选择的分支、乐观的多态内联、分支频率预测、调用频率预测。

* 基于证据的优化技术

精确类型推断、内存值推断、内存值跟踪、常量折叠、重组、操作符退化、空值检查消除、类型检测退化、类型检测消除、代数化简、公共子表达式消除。

* 数据流敏感重写

条件常量传播、基于流承载的类型缩减转换、无用代码消除。

* 语言相关的优化技术

类型继承关系分析、去虚拟机化、符号常量传播、自动装箱消除、逃逸分析、锁消除、锁膨胀、消除反射。

* 内存及代码位置变换

表达式提升、表达式下沉、冗余存储消除、相邻存储合并、交汇点分离。

* 循环变换

循环展开、循环剥离、安全点消除、迭代范围分离、范围检查消除、循环向量化

* 全局代码调整

内联、全局代码外提、基于热度的代码布局、Switch调整

* 控制流图变换

本地代码编排、本地代码封包、延迟槽填充、着色图寄存器分配、线性扫描寄存器分配、复写聚合、常量分裂
复写移除、地址模式匹配、指令窥孔优化、基于确定有限状态机的代码生成。



